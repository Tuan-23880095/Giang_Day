<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang chủ - Tài nguyên học tập</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts: dùng <link> an toàn hơn @import trong <style> -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- (Tùy chọn) stylesheet riêng; KHÔNG dùng @apply vì không build -->
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <meta name="description" content="Ứng dụng ôn tập toán tĩnh, hỗ trợ nhiều đề, chấm điểm offline-first." />
</head>
<body class="antialiased bg-[#f8f7f4] text-gray-800" style="font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif">

  <!-- Header giữ style tương tự trang cũ -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-4 py-5">
      <h1 class="text-3xl font-bold text-blue-800">Trang chủ: Tài nguyên học tập</h1>
      <p class="text-lg text-gray-600 mt-1">Khám phá các chủ đề và tài nguyên</p>
    </div>
  </header>

  <nav-tabs></nav-tabs>

  <!-- CHỈ một <main>; nội dung động sẽ được router render vào đây -->
  <main id="view" class="container mx-auto p-4 md:p-8"></main>

  <!-- Footer luôn ở ngoài <main> để không bị router ghi đè -->
  <contact-footer></contact-footer>

  <!-- Runtime 1 file, không cần build -->
  <script type="module">
    // ======================= DATA (mock) =======================
    const MOCK_DATA = {
      categories: {
        grades: [
          { id: 'g6',  title: 'Khối 6',  description: 'Tài nguyên học tập cho lớp 6',  icon: 'fas fa-leaf',  url: '#/grade/6' },
          { id: 'g10', title: 'Khối 10', description: 'Tài nguyên học tập cho lớp 10', icon: 'fas fa-book', url: '#/grade/10' },
          { id: 'g11', title: 'Khối 11', description: 'Tài nguyên học tập cho lớp 11', icon: 'fas fa-atom', url: '#/grade/11' }
        ],
        math: [
          { id: 'm1', title: 'Dãy số & Cấp số', description: 'Ôn tập dãy số, CSC, CSN', icon: 'fas fa-sort-numeric-down', url: '#/quiz/sequences-01' },
          { id: 'm2', title: 'Hình học Oxyz', description: 'Chuyên đề không gian Oxyz', icon: 'fas fa-cube', url: '#/subject/oxyz' }
        ],
        science: [
          { id: 's1', title: 'Vật Lý: Dao động', description: 'Dao động cơ và sóng', icon: 'fas fa-wave-square', url: '#/subject/physics-waves' },
          { id: 's2', title: 'Hóa học: Este', description: 'Este - Lipit', icon: 'fas fa-vial', url: '#/subject/chemistry-este' }
        ],
        other: [
          { id: 'o1', title: 'HS Nghiên cứu KHTN', description: 'Dự án & hướng dẫn NCKH', icon: 'fas fa-microscope', url: '#/activity/research' },
          { id: 'o2', title: 'Vui cùng Tinh thể', description: 'STEM nuôi tinh thể', icon: 'fas fa-gem', url: '#/activity/crystals' }
        ]
      }
    };

    // ======================= BASE COMPONENT =======================
    class BaseComponent extends HTMLElement {
      setState(p){ this.state = { ...(this.state||{}), ...p }; this.render?.(); }
    }

    // ======================= REPOSITORY (mock) ===================
    class ContentRepository { getItemsByCategoryId(id){ return Promise.resolve(MOCK_DATA.categories[id]||[]); } }

    // ======================= ITEM CARD ===========================
    class ContentItemCard extends BaseComponent {
      connectedCallback(){ this.render(); }
      render(){
        const t = this.getAttribute('data-title')||'';
        const d = this.getAttribute('data-description')||'';
        const i = this.getAttribute('data-icon')||'fas fa-circle';
        const u = this.getAttribute('data-url')||'#';
        this.innerHTML = `
          <a href="${u}" class="block h-full bg-white p-6 rounded-xl shadow-lg border border-gray-100 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
            <div class="flex items-start space-x-4">
              <div class="text-3xl text-blue-600 w-10 text-center"><i class="${i}"></i></div>
              <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-1">${t}</h3>
                <p class="text-gray-600">${d}</p>
              </div>
            </div>
          </a>`;
      }
    }
    customElements.define('content-item-card', ContentItemCard);

    // ======================= CATEGORY BLOCK ======================
    class ContentCategory extends BaseComponent {
      constructor(){ super(); this.repo = new ContentRepository(); this.state={loading:true,items:[]}; }
      async connectedCallback(){
        this.title = this.getAttribute('data-title')||'Danh mục';
        this.iconClass = this.getAttribute('data-icon-class')||'fas fa-folder';
        this.categoryId = this.getAttribute('data-category-id');
        this.render();
        const items = await this.repo.getItemsByCategoryId(this.categoryId);
        this.setState({loading:false, items});
      }
      render(){
        const body = this.state?.loading
          ? '<div class="text-gray-500 italic">Đang tải dữ liệu...</div>'
          : `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              ${(this.state.items||[]).map(it=>`
                <content-item-card data-title="${it.title}" data-description="${it.description}" data-icon="${it.icon}" data-url="${it.url}"></content-item-card>
              `).join('')}
            </div>`;
        this.innerHTML = `
          <section class="mb-12">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 border-b-2 border-blue-200 pb-2">
              <i class="${this.iconClass} mr-3 text-blue-700"></i>${this.title}
            </h2>
            ${body}
          </section>`;
      }
    }
    customElements.define('content-category', ContentCategory);

    // ======================= INFO & FOOTER ========================
    customElements.define('my-info-card', class extends HTMLElement{
      connectedCallback(){ this.innerHTML = `
        <div class="bg-gradient-to-r from-blue-700 to-blue-900 text-white p-8 rounded-xl shadow-2xl flex items-center">
          <img src="https://placehold.co/100x100/ffffff/333333?text=Avatar" alt="Avatar" class="w-24 h-24 rounded-full border-4 border-white mr-6" />
          <div>
            <h2 class="text-3xl font-bold">Thông tin của tôi</h2>
            <p class="text-lg text-blue-200 mt-1">Chào mừng bạn đến với trang tài nguyên cá nhân.</p>
          </div>
        </div>`; }
    });

    customElements.define('contact-footer', class extends HTMLElement{
      connectedCallback(){ this.innerHTML = `
        <footer class="bg-gray-800 text-gray-300 p-8 mt-12">
          <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
              <h3 class="text-xl font-semibold text-white mb-4">Thông tin liên hệ</h3>
              <p class="mb-2"><i class="fas fa-envelope w-6"></i> email-cua-ban@gmail.com</p>
              <p class="mb-2"><i class="fas fa-phone w-6"></i> +84 123 456 789</p>
              <p class="mb-2"><i class="fas fa-map-marker-alt w-6"></i> TP. HCM</p>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-white mb-4">Giới thiệu</h3>
              <p>Nơi chia sẻ tài nguyên, bài giảng và các dự án STEM.</p>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-white mb-4">Liên kết nhanh</h3>
              <ul>
                <li><a href="#/" class="hover:text-white">Trang chủ</a></li>
                <li><a href="#/quiz/sequences-01" class="hover:text-white">Đề mẫu</a></li>
              </ul>
            </div>
          </div>
        </footer>`; }
    });

    // ======================= NAV TABS =============================
    customElements.define('nav-tabs', class extends HTMLElement{
      connectedCallback(){
        this.innerHTML = `
          <nav class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="container mx-auto px-4">
              <div id="nav-tabs" class="flex space-x-4 py-2">
                <a href="#/" class="px-4 py-3 font-semibold text-gray-600 border-b-4 border-transparent transition-all duration-300 tab-button active">Tổng quan</a>
                <a href="#/quiz/sequences-01" class="px-4 py-3 font-semibold text-gray-600 border-b-4 border-transparent transition-all duration-300 tab-button">Phần 1–3 (Đề: sequences-01)</a>
                <a href="#/grade/6" class="px-4 py-3 font-semibold text-gray-600 border-b-4 border-transparent transition-all duration-300 tab-button">Khối 6</a>
              </div>
            </div>
          </nav>`;
        const tabs = this.querySelectorAll('.tab-button');
        const setActive = () => {
          tabs.forEach(t=>{
            t.classList.remove('active','text-blue-700','border-blue-600');
            t.classList.add('text-gray-600','border-transparent');
          });
          const current = [...tabs].find(a => a.getAttribute('href') === (location.hash||'#/'));
          if(current){
            current.classList.add('active','text-blue-700','border-blue-600');
            current.classList.remove('text-gray-600','border-transparent');
          }
        };
        addEventListener('hashchange', setActive);
        setActive();
      }
    });

    // ======================= ROUTER ===============================
    const elView = document.getElementById('view');

    function showHome(){
      if(!elView) return;
      elView.innerHTML = `
        <my-info-card class="mb-10"></my-info-card>
        <content-category data-category-id="grades"  data-title="Các khối lớp"             data-icon-class="fas fa-graduation-cap"></content-category>
        <content-category data-category-id="math"    data-title="Chủ đề Toán học"          data-icon-class="fas fa-calculator"></content-category>
        <content-category data-category-id="science" data-title="Chủ đề Khoa học Tự nhiên"  data-icon-class="fas fa-flask"></content-category>
        <content-category data-category-id="other"   data-title="Hoạt động khác"           data-icon-class="fas fa-palette"></content-category>
      `;
    }

// Ví dụ minh hoạ cách mở rộng hàm showGrade() cho route #/grade/:id
// Hàm này có thể thay vào file index-fixed.html hiện tại
  
  function showGrade(grade) {
    elView.innerHTML = `
      <section class="mb-8">
        <h2 class="section-title text-2xl font-bold mb-2">
          <i class="fas fa-school mr-3 text-blue-700"></i>
          Tài nguyên cho khối ${grade}
        </h2>
        <p class="text-gray-600 mb-4">(Bạn có thể liệt kê các chủ đề hoặc đề minh hoạ cho khối này.)</p>
  
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <a href="#/quiz/sequences-01" class="block bg-white p-6 rounded-xl shadow hover:shadow-xl transition">
            <div class="flex items-center gap-3">
              <i class="fas fa-file-alt text-2xl text-blue-700"></i>
              <div>
                <h3 class="text-xl font-semibold text-gray-800">Đề minh hoạ: Dãy số & Cấp số</h3>
                <p class="text-gray-600">Ôn tập dãy số, cấp số cộng, cấp số nhân.</p>
              </div>
            </div>
          </a>
  
          <a href="#/subject/geometry" class="block bg-white p-6 rounded-xl shadow hover:shadow-xl transition">
            <div class="flex items-center gap-3">
              <i class="fas fa-drafting-compass text-2xl text-blue-700"></i>
              <div>
                <h3 class="text-xl font-semibold text-gray-800">Chủ đề: Hình học không gian</h3>
                <p class="text-gray-600">Ôn tập khối chóp, lăng trụ, góc giữa đường và mặt.</p>
              </div>
            </div>
          </a>
        </div>
  
        <p class="mt-6"><a href="#/" class="text-blue-700 underline">← Quay lại trang chủ</a></p>
      </section>`;
  }
      async function loadQuizJson(id){
        const url = `./content/quizzes/${id}.json`;
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Không tải được ${url}`);
        return res.json();
       }
    function md2html(s){
      return (s||"")
        .replace(/^# (.*)$/gm,'<h1 class="text-2xl font-bold mb-2">$1</h1>')
        .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
        .replace(/\n/g,'<br/>');
    }
    function showScore(score, total){
      let bar = document.querySelector('div[data-scorebar]');
      if (!bar){
        bar = document.createElement('div');
        bar.setAttribute('data-scorebar','');
        bar.className = 'score-bar bg-blue-800 text-white p-4 text-xl font-bold text-center';
        document.body.appendChild(bar);
      }
      bar.textContent = `Điểm số: ${score} / ${total}`;
    }
    async function showQuiz(id){
      const quiz = await loadQuizJson(id);
      elView.innerHTML = '';
    
      const h = document.createElement('h2');
      h.className = 'text-2xl font-bold mb-4';
      h.textContent = `Đề luyện tập: ${quiz.title || id}`;
    
      const wrap = document.createElement('div');
      wrap.className = 'space-y-4';
    
      // gom tất cả câu hỏi về 1 mảng theo thứ tự part1→part2→part3
      const blocks = [ ...(quiz.parts?.part1||[]), ...(quiz.parts?.part2||[]), ...(quiz.parts?.part3||[]) ];
    
      blocks.forEach(b => {
        const card = document.createElement('div');
        card.className = 'question-card';
    
        if (b.type==='choice'){
          card.innerHTML = `
            <div class="font-medium text-lg">${md2html(b.prompt)}</div>
            <ul class="list-none space-y-2 mt-4">
              ${b.choices.map((c,i)=>`
                <li><label class="flex gap-3 items-start">
                  <input name="${b.id}" type="radio" value="${i}" class="mt-1"/>
                  <span class="text-gray-700">${c}</span>
                </label></li>`).join('')}
            </ul>`;
          card.dataset.answer = String(b.answerIndex);
        }
    
        if (b.type==='tf'){
          card.innerHTML = `
            <div class="font-medium text-lg">${md2html(b.prompt)}</div>
            <div class="mt-3 flex gap-6">
              <label class="flex items-center gap-2"><input type="radio" name="${b.id}" value="true"> Đúng</label>
              <label class="flex items-center gap-2"><input type="radio" name="${b.id}" value="false"> Sai</label>
            </div>`;
          card.dataset.answer = String(b.answer);
        }
    
        if (b.type==='sa'){
          card.innerHTML = `
            <div class="font-medium text-lg">${md2html(b.prompt)}</div>
            <input type="text" class="mt-3 w-full border rounded px-3 py-2" placeholder="Nhập đáp án" />`;
          card.dataset.accepted = JSON.stringify(b.acceptedAnswers||[]);
        }
    
        // Lời giải (tùy chọn)
        if (b.solutionHtml){
          const sol = document.createElement('details');
          sol.className = 'solution-content mt-4';
          sol.innerHTML = `<summary class="solution-toggle cursor-pointer inline-block">Xem gợi ý/giải</summary>${b.solutionHtml}`;
          card.appendChild(sol);
        }
    
        wrap.appendChild(card);
      });
    
      // Nút chấm điểm
      const controls = document.createElement('div');
      controls.className = 'mt-4 flex gap-3';
      controls.innerHTML = `
        <button id="btn-check" class="solution-toggle">Kiểm tra</button>
        <button id="btn-reset" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Đặt lại</button>`;
    
      elView.append(h, wrap, controls);
    
      document.getElementById('btn-check').onclick = () => {
        let score = 0, total = 0;
        wrap.querySelectorAll('.question-card').forEach((card)=>{
          const ans = card.dataset.answer;
          const acc = card.dataset.accepted ? JSON.parse(card.dataset.accepted) : null;
          total++;
          if (ans!==undefined){
            // MCQ/TF
            const name = card.querySelector('input')?.getAttribute('name');
            const chosen = wrap.querySelector(`input[name='${name}']:checked`);
            if (chosen && String(chosen.value) === String(ans)) score++;
          } else if (acc){
            // SA
            const val = card.querySelector('input')?.value?.trim()?.replace(/\s+/g,'').toLowerCase();
            if (acc.some(a=>a.replace(/\s+/g,'').toLowerCase()===val)) score++;
          }
        });
        showScore(score, total);
      };
    
      document.getElementById('btn-reset').onclick = ()=> location.reload();

    function route(){
      const h = location.hash || '#/'
      if (h.startsWith('#/quiz/')) {
        const id = h.replace('#/quiz/','').trim();
        return showQuiz(id);
      }
      if (h.startsWith('#/grade/')) {
        const g = h.replace('#/grade/','').trim();
        return showGrade(g);
      }
      return showHome();
    }

    window.addEventListener('hashchange', route);
    // chạy lần đầu
    route();
  </script>

</body>
</html>
