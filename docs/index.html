<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trang chủ - Tài nguyên học tập</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- Font Awesome (icons) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- CSS thuần của bạn (không dùng @apply) -->
  <link rel="stylesheet" href="./assets/css/styles.css" />
  <meta name="description" content="Ứng dụng ôn tập toán tĩnh, hỗ trợ nhiều đề, chấm điểm offline-first." />
  <style>
    body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
    /* Thanh điểm cố định đáy màn hình */
    .score-bar{position:fixed;left:0;bottom:0;width:100%;}
    /* Card thống nhất khi không build Tailwind */
    .content-card{background:#fff;border:1px solid #eef1f6;border-radius:0.75rem;padding:1.5rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);transition:transform .2s, box-shadow .2s}
    .content-card:hover{transform:translateY(-2px);box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}
    .solution-toggle{display:inline-block;padding:.5rem 1rem;background:#1d4ed8;color:#fff;border-radius:.5rem}
    .solution-content{background:#f8fafc;border:1px solid #e5e7eb;border-radius:.5rem;padding:1rem}
    /* Đệm dưới để không che nội dung bởi score-bar */
    main{padding-bottom:4.5rem}
  </style>
</head>
<body class="antialiased bg-[#f8f7f4] text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-4 py-5">
      <h1 class="text-3xl font-bold text-blue-800">Trang chủ: Tài nguyên học tập</h1>
      <p class="text-lg text-gray-600 mt-1">Khám phá các chủ đề và tài nguyên</p>
    </div>
  </header>

  <nav-tabs></nav-tabs>

  <!-- Container để router bơm nội dung -->
  <main id="view" class="container mx-auto p-4 md:p-8"></main>

  <contact-footer></contact-footer>

  <!-- Runtime 1 file, không cần build -->
  <script type="module">
    // ======================= DATA (mock) =======================
    const MOCK_DATA = {
      categories: {
        grades: [
          { id: 'g6',  title: 'Khối 6',  description: 'Tài nguyên học tập cho lớp 6',  icon: 'fas fa-leaf',  url: '#/grade/6' },
          { id: 'g10', title: 'Khối 10', description: 'Tài nguyên học tập cho lớp 10', icon: 'fas fa-book', url: '#/grade/10' },
          { id: 'g11', title: 'Khối 11', description: 'Tài nguyên học tập cho lớp 11', icon: 'fas fa-atom', url: '#/grade/11' }
        ],
        math: [
          { id: 'm1', title: 'Dãy số & Cấp số', description: 'Ôn tập dãy số, CSC, CSN', icon: 'fas fa-sort-numeric-down', url: '#/quiz/sequences-01' },
          { id: 'm2', title: 'Hình học Oxyz', description: 'Chuyên đề không gian Oxyz', icon: 'fas fa-cube', url: '#/subject/oxyz' }
        ],
        science: [
          { id: 's1', title: 'Vật Lý: Dao động', description: 'Dao động cơ và sóng', icon: 'fas fa-wave-square', url: '#/subject/physics-waves' },
          { id: 's2', title: 'Hóa học: Este', description: 'Este - Lipit', icon: 'fas fa-vial', url: '#/subject/chemistry-este' }
        ],
        other: [
          { id: 'o1', title: 'HS Nghiên cứu KHTN', description: 'Dự án & hướng dẫn NCKH', icon: 'fas fa-microscope', url: '#/activity/research' },
          { id: 'o2', title: 'Vui cùng Tinh thể', description: 'STEM nuôi tinh thể', icon: 'fas fa-gem', url: '#/activity/crystals' }
        ]
      }
    };

    // ======================= UTILS =============================
    /** Parser Markdown siêu gọn dùng cho prompt: #, **bold** và xuống dòng */
    function md2html(s=''){
      return String(s)
        .replace(/^# (.*)$/gm,'<h1 class="text-2xl font-bold mb-2'>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g,'<b>$1</b>')
        .replace(/\n/g,'<br/>');
    }

    // Tải JSON đề từ thư mục /docs/content/... (dùng đường dẫn TƯƠNG ĐỐI)
    async function loadQuizJson(id){
      const url = `./content/quizzes/${id}.json`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`Không tải được ${url}`);
      return res.json();
    }

    function showScore(score, total){
      let bar = document.querySelector('div[data-scorebar]');
      if(!bar){
        bar = document.createElement('div');
        bar.setAttribute('data-scorebar','');
        bar.className = 'score-bar bg-blue-800 text-white p-4 text-xl font-bold text-center';
        document.body.appendChild(bar);
      }
      bar.textContent = `Điểm số: ${score} / ${total}`;
    }

    // ======================= BASE COMPONENT =====================
    class BaseComponent extends HTMLElement {
      setState(p){ this.state = { ...(this.state||{}), ...p }; this.render?.(); }
    }

    // ======================= REPOSITORY (mock) ==================
    class ContentRepository { getItemsByCategoryId(id){ return Promise.resolve(MOCK_DATA.categories[id]||[]); } }

    // ======================= ITEM CARD ==========================
    class ContentItemCard extends BaseComponent {
      connectedCallback(){ this.render(); }
      render(){
        const t = this.getAttribute('data-title')||'';
        const d = this.getAttribute('data-description')||'';
        const i = this.getAttribute('data-icon')||'fas fa-circle';
        const u = this.getAttribute('data-url')||'#';
        this.innerHTML = `
          <a href="${u}" class="content-card block h-full">
            <div class="flex items-start space-x-4">
              <div class="text-3xl text-blue-600 w-10 text-center"><i class="${i}"></i></div>
              <div>
                <h3 class="text-xl font-semibold text-gray-800 mb-1">${t}</h3>
                <p class="text-gray-600">${d}</p>
              </div>
            </div>
          </a>`;
      }
    }
    customElements.define('content-item-card', ContentItemCard);

    // ======================= CATEGORY BLOCK =====================
    class ContentCategory extends BaseComponent {
      constructor(){ super(); this.repo = new ContentRepository(); this.state={loading:true,items:[]}; }
      async connectedCallback(){
        this.title = this.getAttribute('data-title')||'Danh mục';
        this.iconClass = this.getAttribute('data-icon-class')||'fas fa-folder';
        this.categoryId = this.getAttribute('data-category-id');
        this.render();
        const items = await this.repo.getItemsByCategoryId(this.categoryId);
        this.setState({loading:false, items});
      }
      render(){
        const body = this.state?.loading
          ? '<div class="text-gray-500 italic">Đang tải dữ liệu...</div>'
          : `
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${(this.state.items||[]).map(it=>`
                <content-item-card data-title="${it.title}" data-description="${it.description}" data-icon="${it.icon}" data-url="${it.url}"></content-item-card>
            `).join('')}</div>`;
        this.innerHTML = `
          <section class="mb-12">
            <h2 class="text-2xl font-bold text-blue-800 mb-6 border-b-2 border-blue-200 pb-2">
              <i class="${this.iconClass} mr-3 text-blue-700"></i>${this.title}
            </h2>
            ${body}
          </section>`;
      }
    }
    customElements.define('content-category', ContentCategory);

    // ======================= INFO & FOOTER =======================
    customElements.define('my-info-card', class extends HTMLElement{
      connectedCallback(){ this.innerHTML = `
        <div class="bg-gradient-to-r from-blue-700 to-blue-900 text-white p-8 rounded-xl shadow-2xl flex items-center">
          <img src="https://placehold.co/100x100/ffffff/333333?text=Avatar" alt="Avatar" class="w-24 h-24 rounded-full border-4 border-white mr-6" />
          <div>
            <h2 class="text-3xl font-bold">Thông tin của tôi</h2>
            <p class="text-lg text-blue-200 mt-1">Chào mừng bạn đến với trang tài nguyên cá nhân.</p>
          </div>
        </div>`; }
    });

    customElements.define('contact-footer', class extends HTMLElement{
      connectedCallback(){ this.innerHTML = `
        <footer class="bg-gray-800 text-gray-300 p-8 mt-12">
          <div class="container mx-auto grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
              <h3 class="text-xl font-semibold text-white mb-4">Thông tin liên hệ</h3>
              <p class="mb-2"><i class="fas fa-envelope w-6"></i> email-cua-ban@gmail.com</p>
              <p class="mb-2"><i class="fas fa-phone w-6"></i> +84 123 456 789</p>
              <p class="mb-2"><i class="fas fa-map-marker-alt w-6"></i> TP. HCM</p>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-white mb-4">Giới thiệu</h3>
              <p>Nơi chia sẻ tài nguyên, bài giảng và các dự án STEM.</p>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-white mb-4">Liên kết nhanh</h3>
              <ul>
                <li><a href="#/" class="hover:text-white">Trang chủ</a></li>
                <li><a href="#/quiz/sequences-01" class="hover:text-white">Đề mẫu</a></li>
              </ul>
            </div>
          </div>
        </footer>`; }
    });

        <!-- ======================= NAV TABS (REPLACE) ============================ -->
    <script type="module">
    customElements.define('nav-tabs', class extends HTMLElement{
      connectedCallback(){
        this.innerHTML = `
          <nav class="bg-white border-b border-gray-200 sticky top-0 z-10">
            <div class="container mx-auto px-4">
              <div id="nav-tabs" class="flex flex-wrap gap-2 py-2">
                <!-- Tổng quan -->
                <a href="#/" 
                   class="px-4 py-3 font-semibold border-b-4 transition-all duration-300 tab-button"
                   data-match="^#/$">Tổng quan</a>
    
                <!-- Quiz: khớp mọi route bắt đầu bằng #/quiz/ -->
                <a href="#/quiz/sequences-01" 
                   class="px-4 py-3 font-semibold border-b-4 transition-all duration-300 tab-button"
                   data-match="^#/quiz/">
                   Phần 1–3 (Đề: sequences-01)
                </a>
    
                <!-- Grade: khớp mọi route bắt đầu bằng #/grade/ (ví dụ #/grade/6) -->
                <a href="#/grade/6" 
                   class="px-4 py-3 font-semibold border-b-4 transition-all duration-300 tab-button"
                   data-match="^#/grade/">
                   Khối 6
                </a>
              </div>
            </div>
          </nav>`;
    
        const tabs = this.querySelectorAll<HTMLAnchorElement>('.tab-button');
    
        const setActive = () => {
          const h = location.hash || '#/';
          tabs.forEach(a => {
            // reset style
            a.classList.remove('text-blue-700','border-blue-600','active');
            a.classList.add('text-gray-600','border-transparent');
            // kích hoạt nếu regex trong data-match khớp hash hiện tại
            const rx = a.getAttribute('data-match');
            if (rx && new RegExp(rx).test(h)) {
              a.classList.add('text-blue-700','border-blue-600','active');
              a.classList.remove('text-gray-600','border-transparent');
            }
          });
        };
    
        window.addEventListener('hashchange', setActive);
        setActive(); // chạy lần đầu
      }
    });
    </script>


    // ======================= ROUTER & PAGES ======================
    const elView = document.getElementById('view');

    function showHome(){
      elView.innerHTML = `
        <my-info-card class="mb-10"></my-info-card>
        <content-category data-category-id="grades"  data-title="Các khối lớp"             data-icon-class="fas fa-graduation-cap"></content-category>
        <content-category data-category-id="math"    data-title="Chủ đề Toán học"          data-icon-class="fas fa-calculator"></content-category>
        <content-category data-category-id="science" data-title="Chủ đề Khoa học Tự nhiên" data-icon-class="fas fa-flask"></content-category>
        <content-category data-category-id="other"   data-title="Hoạt động khác"           data-icon-class="fas fa-palette"></content-category>`;
    }

    function showGrade(grade){
      elView.innerHTML = `
        <section class="mb-8">
          <h2 class="text-2xl font-bold text-blue-800 mb-2"><i class="fas fa-school mr-3 text-blue-700"></i>Tài nguyên cho khối ${grade}</h2>
          <p class="text-gray-600 mb-4">(Bạn có thể liệt kê các mục dành riêng cho khối ${grade} ở đây.)</p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <a href="#/quiz/sequences-01" class="content-card block">Đề minh họa: Dãy số & Cấp số</a>
          </div>
          <p class="mt-6"><a href="#/" class="text-blue-700 underline">← Quay lại trang chủ</a></p>
        </section>`;
    }

    async function showQuiz(id){
      const h = document.createElement('h2');
      h.className = 'text-2xl font-bold mb-4';
      h.innerHTML = `Đề luyện tập: <code>${id}</code>`;

      const wrap = document.createElement('div');
      wrap.className = 'space-y-4';

      // Helper render 1 câu hỏi
      function renderBlock(b){
        const card = document.createElement('div');
        card.className = 'content-card question-card';

        if (b.kind==='choice'){
          card.innerHTML = `
            <div class="font-medium text-lg">${md2html(b.q.prompt)}</div>
            <ul class="list-none space-y-2 mt-4">${b.q.choices.map((c,i)=>`
                <li><label class="flex gap-3 items-start">
                  <input name="${b.q.id}" type="radio" value="${i}" class="mt-1" />
                  <span class="text-gray-700">${c}</span>
                </label></li>`).join('')}
            </ul>`;
          card.dataset.answer = String(b.q.answerIndex);
        }

        if (b.kind==='tf'){
          card.innerHTML = `
            <div class="font-medium text-lg">${md2html(b.q.prompt)}</div>
            <div class="mt-3 flex gap-6">
              <label class="flex items-center gap-2"><input type="radio" name="${b.q.id}" value="true"> Đúng</label>
              <label class="flex items-center gap-2"><input type="radio" name="${b.q.id}" value="false"> Sai</label>
            </div>`;
          card.dataset.answer = String(b.q.answer);
        }

        if (b.kind==='sa'){
          card.innerHTML = `
            <div class="font-medium text-lg">${md2html(b.q.prompt)}</div>
            <input type="text" class="mt-3 w-full border rounded px-3 py-2" placeholder="Nhập đáp án" />`;
          card.dataset.accepted = JSON.stringify(b.q.acceptedAnswers||[]);
        }

        if (b.q.solutionHtml){
          const sol = document.createElement('details');
          sol.className = 'solution-content mt-4';
          sol.innerHTML = `<summary class="solution-toggle cursor-pointer inline-block">Xem gợi ý/giải</summary>${b.q.solutionHtml}`;
          card.appendChild(sol);
        }
        wrap.appendChild(card);
      }

      // Nạp JSON thật
      try{
        const j = await loadQuizJson(id);
        const blocks = [
          ...(j.parts.part1||[]).map(q=>({kind:'choice', q})),
          ...(j.parts.part2||[]).map(q=>({kind:'tf', q})),
          ...(j.parts.part3||[]).map(q=>({kind:'sa', q})),
        ];
        blocks.forEach(renderBlock);
      }catch(err){
        wrap.innerHTML = `<div class="text-red-600">${err.message}</div>`;
      }

      // Nút chấm điểm
      const controls = document.createElement('div');
      controls.className = 'mt-4 flex gap-3';
      controls.innerHTML = `
        <button id="btn-check" class="solution-toggle">Kiểm tra</button>
        <button id="btn-reset" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">Đặt lại</button>`;

      elView.innerHTML = '';
      elView.append(h, wrap, controls);

      document.getElementById('btn-check').onclick = () => {
        let score = 0, total = 0;
        wrap.querySelectorAll('.question-card').forEach((card)=>{
          const ans = card.dataset.answer;
          const acc = card.dataset.accepted ? JSON.parse(card.dataset.accepted) : null;
          total++;
          if (ans!==undefined){
            // MCQ/TF
            const name = card.querySelector('input')?.getAttribute('name');
            const chosen = wrap.querySelector(`input[name='${name}']:checked`);
            if (chosen && String(chosen.value) === String(ans)) score++;
          } else if (acc){
            // SA
            const input = card.querySelector('input');
            const val = (input?.value||'').trim().replace(/\s+/g,'').toLowerCase();
            if (acc.some(a=>String(a).replace(/\s+/g,'').toLowerCase()===val)) score++;
          }
        });
        showScore(score, total);
      };
      document.getElementById('btn-reset').onclick = ()=> location.reload();
    }

    function route(){
      const h = location.hash || '#/'
      if (h.startsWith('#/quiz/')) {
        const id = h.replace('#/quiz/','').trim();
        return showQuiz(id);
      }
      if (h.startsWith('#/grade/')) {
        const g = h.replace('#/grade/','').trim();
        return showGrade(g);
      }
      return showHome();
    }

    window.addEventListener('hashchange', route);
    route();
  </script>
</body>
</html>
